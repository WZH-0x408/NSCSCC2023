# NSCSCC2023
# NSCSCC2023 龙芯杯团体赛设计报告
##### 团队名：你说的队
###### 队长：王梓任
###### 队员：王子涵、储梓阳
##### 清华大学
##### 2023年8月5日

 
### 1）设计简介
&emsp;&emsp;本队设计的myCPU_top​是针对“龙芯杯”计算机系统能力培养大赛设计的一款MIPS32处理器核，采用静态单发射五级流水线架构，支持“系统能力培养大赛”MIPS指令系统规范v1.01（下称“规范”）中列出的所有57条指令，还为非对齐访存指令LWL，LWR，SWL，SWR提供支持。

&emsp;&emsp;myCPU_top针对流水线的控制和冒险，以前递和阻塞技术解决数据相关问题和load-use hazard，利用延迟槽技术解决了分支跳转问题。myCPU提供地址错例外、保留指令例外、整形溢出例外、断点例外、系统调用例外以及包括外部中断和硬件中断的中断例外的支持，并为CP0实现了Cause，Status，EPC，badVaddr，Count和Compare寄存器。

&emsp;&emsp;myCPU以固定地址映射方式进行存储管理，myCPU的访存接口为SRAM接口，因此不支持AXI随机延迟。

### 2）设计方案
![Alt text](image.png)
（原理框图）
#### （一）总体设计方案
&emsp;&emsp;myCPU_top的总体结构实现参考了汪文祥、邢金璋所著的《CPU设计实战》中的开源实验资源，为静态单发射五级流水线架构。

&emsp;&emsp;流水线分为取指（IF）、译码（ID）、执行（EXE）、访存（MEM）和写回（WB）。流水级之间插入寄存器，并采用逐级互锁的控制逻辑，调整流水级寄存器的控制信号实现阻塞和清空流水线等功能。

#### （二）IF级模块设计方案
myCPU_top的IF级模块实际上分为pre-IF和IF两部分。pre-IF完成跳转控制，IF级通过读地址和使能输入，实现与指令RAM的交互，并实现取指地址错例外的检测。

#### （三）ID级模块设计方案
&emsp;&emsp;myCPU_top使用fs_to_ds_bus_r实现IF-ID级间的寄存器，并添加了逐级互锁的控制逻辑。

&emsp;&emsp;myCPU_top将通用寄存器堆regfile模块在ID级进行例化，为避免“先写后读”冒险，建立了EXE，MEM级到ID的前递数据通路，并为通用寄存器堆添加了先读后写支持。

&emsp;&emsp;ID级使用了数个译码器模块，如decoder_5_32和decoder_6_64，实现控制信号的生成。此外，ID级实现了保留指令例外的检测并向后级传递信息。

&emsp;&emsp;为避免控制冒险，在ID级实现跳转指令的判断，并通过br_bus前递到IF级，参与pre-IF阶段pc的生成。这一数据通路被复用以判断IF级的指令是否在延迟槽中。

#### （四）EXE级模块设计方案
&emsp;&emsp;myCPU_top使用ds_to_es_bus_r实现ID-EXE级间的寄存器，传递各类控制信号，并添加了逐级互锁的控制逻辑。为避免load-use hazard，建立了EXE到ID级的数据通路以检测load-use的情况，并在ID级配合以相应的阻塞逻辑控制。

&emsp;&emsp;为支持运算指令，在EXE级模块中例化了ALU，并为乘除指令，使用Vivado的除法器IP，完成有符号和无符号除法的运算，例化了HILO寄存器模块以存储结果。针对除法运算需要多个周期的特点，添加了相应的阻塞控制。针对运算，添加了整型溢出例外的检测并向后级传递信息。

&emsp;&emsp;基于同步RAM的特性，myCPU_top在EXE级进行数据RAM读写地址和使能信号的输入，此处实现了访存的读写地址错例外检测并向后级传递信息。

&emsp;&emsp;为实现精确例外，建立了MEM、WB到EXE的数据通路，传递两级异常的判断信号，若检测到MEM级和WB级存在异常，则将HILO和RAM的写使能无效。

#### （五）MEM级模块设计方案
&emsp;&emsp;myCPU_top使用es_to_ms_bus_r实现EXE-MEM级间的寄存器，传递各类控制信号，并添加了逐级互锁的控制逻辑。MEM级进行访存数据的读出，根据前级传递来的控制信号选择访存或ALU结果并向后传递。

#### （六）WB级模块设计方案
&emsp;&emsp;在WB和ID级的regfile通用寄存器模块之间建立数据通路，实现了数据的写回。

&emsp;&emsp;指令在WB级报出例外，WB级模块与其中例化的CP0寄存器模块进行交互，产生清空流水线的控制信号，清空各级流水线，并建立了到IF级的数据通路实现异常入口的跳转。此外，将硬件中断的输入设置在WB级，实现中断的判定，并前递到ID级进行中断标记。

### 3）备注说明
本工程使用Vivado 2023开发，使用其他版本打开可能有兼容问题。
参考了汪文祥、邢金璋著的《CPU设计实战》。在实现过程中，使用了开源的实验资源lab3代码作为基础进行开发。

### 5）参考文献
[1] 汪文祥、邢金璋.CPU设计实战.北京：机械工业出版社，2021
